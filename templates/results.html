<!DOCTYPE html>
<html>
<head>
    <title>Результаты обработки</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mini.css/3.0.1/mini-default.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <style>
        /* Добавьте необходимые стили для галереи и модального окна */
        .gallery {
            display: flex;
            flex-wrap: wrap;
        }
        .gallery-item {
            margin: 5px;
        }
        .gallery-item img {
            width: 200px;
            height: auto;
            cursor: pointer;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 999;
            padding-top: 60px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
        }
        .modal-content {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 700px;
            position: relative;
        }
        .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
        #filter-container {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Результаты обработки</h1>
        <div>
            <a href="/uploaded_images/submission.csv" download>
                <button>Скачать CSV</button>
            </a>
            <a href="/report/">
                <button>Перейти к отчёту</button>
            </a>
        </div>
    </div>
    <div id="filter-container">
        <label>
            <input type="checkbox" id="hide-empty" onchange="filterImages()">
            Скрыть пустые изображения
        </label>
    </div>
    <div class="gallery" id="gallery">
        {% for result in results %}
            <div class="gallery-item {% if result.is_empty == 0 %}empty{% endif %}" data-filename="{{ result.filename }}" data-bbox='{{ result.bbox | tojson }}' data-is-empty="{{ result.is_empty }}">
                <img src="/uploaded_images/{{ result.filename }}" alt="{{ result.filename }}">
            </div>
        {% endfor %}
    </div>

    <!-- Модальное окно для отображения изображения -->
    <div id="modal" class="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <canvas id="modal-image" class="modal-content"></canvas>
    </div>

    <script>
        // Фильтрация изображений
        function filterImages() {
            var hideEmpty = document.getElementById('hide-empty').checked;
            var items = document.querySelectorAll('.gallery-item');
            items.forEach(function(item) {
                if (hideEmpty && item.classList.contains('empty')) {
                    item.style.display = 'none';
                } else {
                    item.style.display = 'inline-block';
                }
            });
        }

        // Обработчик клика по изображению
        var galleryItems = document.querySelectorAll('.gallery-item img');
        galleryItems.forEach(function(img) {
            img.addEventListener('click', function() {
                var parent = img.parentElement;
                var filename = parent.getAttribute('data-filename');
                var bbox = JSON.parse(parent.getAttribute('data-bbox'));
                var isEmpty = parseInt(parent.getAttribute('data-is-empty'));

                showModal(filename, bbox, isEmpty);
            });
        });

        // Показать модальное окно с изображением
        function showModal(filename, bbox, isEmpty) {
            var modal = document.getElementById('modal');
            var canvas = document.getElementById('modal-image');
            var ctx = canvas.getContext('2d');

            var img = new Image();
            img.src = '/uploaded_images/' + filename;
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);

                if (bbox) {
                    ctx.strokeStyle = isEmpty === 1 ? 'green' : 'red';
                    ctx.lineWidth = 4;
                    ctx.strokeRect(bbox.x, bbox.y, bbox.width, bbox.height);
                }
            };

            modal.style.display = 'block';
        }

        // Закрыть модальное окно
        function closeModal() {
            var modal = document.getElementById('modal');
            modal.style.display = 'none';
        }

        // Закрытие модального окна при клике вне изображения
        window.onclick = function(event) {
            var modal = document.getElementById('modal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };
    </script>
</body>
</html>
