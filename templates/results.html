<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Результаты обработки</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mini.css/3.0.1/mini-default.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <style>
        /* Основной контейнер */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }

        /* Заголовок страницы */
        .main-title {
            font-size: 2rem;
            text-align: center;
            color: #2c3e50;
            margin-top: 20px;
            padding: 10px 0;
        }

        /* Кнопки сверху */
        .button-wrapper {
            text-align: center;
            margin: 20px 0;
        }

        .button {
            background-color: #90ee90;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 5px;
            margin: 0 10px;
            text-align: center;
        }

        .button:hover {
            opacity: 0.9;
        }

        /* Сеточная галерея */
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            padding: 20px;
        }

        .gallery-item img {
            width: 100%;
            height: auto;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Модальное окно */
        .modal {
            display: none;
            position: fixed;
            z-index: 999;
            padding-top: 60px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
        }

        .modal-content {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 700px;
            position: relative;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="main-title">Результаты обработки</div>

    <!-- Кнопки -->
    <div class="button-wrapper">
        <a href="/uploaded_images/submission.csv" download>
            <button class="button">Скачать CSV</button>
        </a>
        <a href="/report/">
            <button class="button">Перейти к отчёту</button>
        </a>
    </div>

    <!-- Галерея изображений -->
    <div class="gallery" id="gallery">
        {% for result in results %}
            <div class="gallery-item {% if result.is_empty == 0 %}empty{% endif %}" data-filename="{{ result.filename }}" data-bbox='{{ result.bbox | tojson }}' data-is-empty="{{ result.is_empty }}">
                <img src="/uploaded_images/{{ result.filename }}" alt="{{ result.filename }}">
            </div>
        {% endfor %}
    </div>

    <!-- Модальное окно для отображения изображения -->
    <div id="modal" class="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <canvas id="modal-image" class="modal-content"></canvas>
    </div>

    <script>
        // Обработчик клика по изображению
        var galleryItems = document.querySelectorAll('.gallery-item img');
        galleryItems.forEach(function(img) {
            img.addEventListener('click', function() {
                var parent = img.parentElement;
                var filename = parent.getAttribute('data-filename');
                var bbox = JSON.parse(parent.getAttribute('data-bbox'));
                var isEmpty = parseInt(parent.getAttribute('data-is-empty'));

                showModal(filename, bbox, isEmpty);
            });
        });

        // Показать модальное окно с изображением
        function showModal(filename, bbox, isEmpty) {
            var modal = document.getElementById('modal');
            var canvas = document.getElementById('modal-image');
            var ctx = canvas.getContext('2d');

            var img = new Image();
            img.src = '/uploaded_images/' + filename;
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);

                if (bbox) {
                    ctx.strokeStyle = isEmpty === 1 ? 'green' : 'red';
                    ctx.lineWidth = 4;
                    ctx.strokeRect(bbox.x, bbox.y, bbox.width, bbox.height);
                }
            };

            modal.style.display = 'block';
        }

        // Закрыть модальное окно
        function closeModal() {
            var modal = document.getElementById('modal');
            modal.style.display = 'none';
        }

        // Закрытие модального окна при клике вне изображения
        window.onclick = function(event) {
            var modal = document.getElementById('modal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };
    </script>
    <!-- Кнопка для удаления всех изображений -->
<div class="button-wrapper">
    <button class="button" id="delete-images-button">Удалить все изображения</button>
</div>

<script>
    // Обработчик клика по кнопке удаления изображений
    document.getElementById('delete-images-button').addEventListener('click', function() {
        if (confirm("Вы уверены, что хотите удалить все изображения?")) {
            // Перенаправляем пользователя на главную страницу
            window.location.href = '/';

            // Ждем несколько секунд, чтобы главная страница успела загрузиться
            setTimeout(function() {
                // Теперь отправляем запрос на удаление изображений
                fetch('/delete_images', {
                    method: 'DELETE',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        alert(data.message);
                    } else {
                        alert('Ошибка при удалении изображений');
                    }
                })
                .catch(error => {
                    alert('Ошибка при запросе: ' + error);
                });
            }, 2000); // 2 секунды на загрузку главной страницы перед отправкой запроса
        }
    });
</script>

</body>
</html>
